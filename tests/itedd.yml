---
- hosts: app
  become: yes

  vars:
    profile: "/bin/bash -lc -- "
    rails_release_id: "test" # do not create release on every run

  pre_tasks:
  - name: Create App User
    user:
      name:   "{{ app_user }}"
      groups: "www-data"
      state:  "present"

  roles:
  - postgresql

  - ruby/rvm
  - ruby/postgresql
  - ruby/sqlite3

  - rails/folders
  - rails/logrotate
  - role: user/profile
    rails_user_name: "{{ app_user }}"
    rails_user_bashrc_lines:
    - "cd {{ RAILS_APP_BASE_PATH }} || true"
    - "cd {{ RAILS_APP_CURRENT_PATH }} || true"
    rails_user_env:
      RAILS_ENV: "{{ rails_env }}"
      SECRET_KEY_BASE: "{{ app_secret_key_base }}"
      RAILS_LOG_FILE_PATH: "{{ RAILS_APP_LOG_PATH }}"
      DATABASE_URL: "{{ DATABASE_URL }}"

  - role: upstart/userjobs
    users:
    - "{{ app_user }}"
  - webrick/service
  - nginx/server
  - nginx/webrick

  - role: rails/folders
    become_user: '{{ app_user }}'

  - role: rails/create-release
    become_user: '{{ app_user }}'
    rails_deploy_custom_archive:
    - Gemfile.lock

  - role: rails/tasks/bundle
    become_user: '{{ app_user }}'

  - role: rails/tasks/migrate-database
    become_user: '{{ app_user }}'

  - role: rails/tasks/compile-assets
    become_user: '{{ app_user }}'

  - role: rails/update-current
    become_user: '{{ app_user }}'

  - role: webrick/restart
    become_user: '{{ app_user }}'

  - role: rails/cleanup-old-releases
    become_user: '{{ app_user }}'
